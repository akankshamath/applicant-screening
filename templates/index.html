<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hackerhouse Screener</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #e8e8e8;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    h1 {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: #fff;
    }

    .subtitle {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 32px;
    }

    /* Bulk input */
    .bulk-section {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 28px;
    }

    .bulk-section h2 {
      font-size: 1.1rem;
      margin-bottom: 12px;
      color: #fff;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #111;
      color: #fff;
      font-size: 0.88rem;
      font-family: monospace;
      resize: vertical;
      outline: none;
      min-height: 120px;
    }

    textarea:focus { border-color: #4f8ef7; }

    .bulk-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }

    button {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: #4f8ef7;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }

    button:hover { background: #3a7de0; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    button.secondary {
      background: transparent;
      border: 1px solid #444;
      color: #888;
    }

    button.secondary:hover { border-color: #888; color: #ccc; background: transparent; }

    .progress {
      color: #888;
      font-size: 0.85rem;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
      background: #1a1a1a;
      color: #fff;
      font-size: 0.85rem;
      outline: none;
    }

    .filters input:focus { border-color: #4f8ef7; }

    /* Table */
    .results-table {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #111;
      border-bottom: 1px solid #2a2a2a;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
    }

    td {
      padding: 14px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid #222;
    }

    tr:last-child td { border-bottom: none; }

    tbody tr:hover { background: #1a1a1a; }

    td a {
      color: #4f8ef7;
      text-decoration: none;
    }

    td a:hover { text-decoration: underline; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .error {
      display: none;
      background: #2a1111;
      border: 1px solid #5a2020;
      border-radius: 10px;
      padding: 16px 20px;
      color: #f87171;
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    .error.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Hackerhouse Screener</h1>
    <p class="subtitle">Bulk screen LinkedIn profiles â€” paste URLs, get a scannable table</p>

    <div class="error" id="errorBox"></div>

    <!-- Bulk Input -->
    <div class="bulk-section">
      <h2>ðŸ“‹ Paste LinkedIn URLs</h2>
      <textarea id="urlsInput" placeholder="Paste LinkedIn profile URLs here (one per line)&#10;https://www.linkedin.com/in/username1&#10;https://www.linkedin.com/in/username2&#10;https://www.linkedin.com/in/username3"></textarea>
      <div class="bulk-actions">
        <button onclick="screenAll()" id="screenBtn">Screen All</button>
        <button class="secondary" onclick="clearResults()">Clear Results</button>
        <button class="secondary" onclick="exportCSV()">Export CSV</button>
        <span class="progress" id="progress"></span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters" id="filters" style="display: none;">
      <input type="text" id="filterSchool" placeholder="Filter by school..." oninput="applyFilters()">
      <input type="text" id="filterCompany" placeholder="Filter by company..." oninput="applyFilters()">
      <input type="number" id="filterMinTenure" placeholder="Min time (years)" oninput="applyFilters()">
      <input type="number" id="filterMaxTenure" placeholder="Max time (years)" oninput="applyFilters()">
    </div>

    <!-- Results Table -->
    <div class="results-table" id="resultsTable" style="display: none;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Current Company</th>
            <th>Time</th>
            <th>School</th>
            <th>Degree</th>
            <th>Profile</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>

    <div class="empty-state" id="emptyState">
      Paste LinkedIn URLs above and click "Screen All" to get started
    </div>
  </div>

  <script>
    let allResults = [];

    // HTML escape function to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message) {
      const errorBox = document.getElementById("errorBox");
      errorBox.textContent = message;
      errorBox.className = "error active";
      setTimeout(() => {
        errorBox.className = "error";
      }, 5000);
    }

    async function screenAll() {
      const urls = document.getElementById("urlsInput").value
        .split("\n")
        .map(u => u.trim())
        .filter(u => u && u.includes("linkedin.com"));

      if (urls.length === 0) {
        showError("Please paste at least one LinkedIn URL");
        return;
      }

      document.getElementById("errorBox").className = "error";
      document.getElementById("screenBtn").disabled = true;
      allResults = [];
      let failureCount = 0;

      for (let i = 0; i < urls.length; i++) {
        document.getElementById("progress").textContent = `Processing ${i + 1} of ${urls.length}...`;

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

          const res = await fetch("/screen", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: urls[i] }),
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          const data = await res.json();

          if (res.ok && !data.error) {
            const posStart = data.current_company?.position_start;
            let tenure = "â€”";
            let tenureYears = null;

            if (posStart && posStart.year) {
              const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
              const month = posStart.month ? monthNames[posStart.month - 1] : "";
              tenure = `${month} ${posStart.year}â€“Present`.trim();

              // Calculate tenure in years
              const now = new Date();
              const startYear = posStart.year;
              const startMonth = posStart.month || 1;
              tenureYears = now.getFullYear() - startYear;
              if (now.getMonth() + 1 < startMonth) {
                tenureYears -= 1;
              }
            }

            allResults.push({
              url: urls[i],
              name: data.name,
              currentCompany: data.current_company?.name || "â€”",
              tenure: tenure,
              tenureYears: tenureYears,
              school: data.education[0]?.school || "â€”",
              degree: data.education[0]?.degree || "â€”",
            });
          } else {
            failureCount++;
            allResults.push({
              url: urls[i],
              name: "Error",
              currentCompany: data.error || "Failed to fetch",
              tenure: "â€”",
              tenureYears: null,
              school: "â€”",
              degree: "â€”",
            });
          }
        } catch (err) {
          failureCount++;
          let errorMsg = "Network error";
          if (err.name === 'AbortError') {
            errorMsg = "Request timeout (30s)";
          } else if (err.message) {
            errorMsg = err.message;
          }
          allResults.push({
            url: urls[i],
            name: "Error",
            currentCompany: errorMsg,
            tenure: "â€”",
            tenureYears: null,
            school: "â€”",
            degree: "â€”",
          });
        }

        renderResults();
      }

      const successCount = urls.length - failureCount;
      document.getElementById("progress").textContent = `âœ“ Screened ${urls.length} profiles (${successCount} successful, ${failureCount} failed)`;

      if (failureCount > 0 && failureCount === urls.length) {
        showError("All requests failed. Please check your API credentials and try again.");
      } else if (failureCount > urls.length / 2) {
        showError(`${failureCount} out of ${urls.length} requests failed. Some profiles could not be retrieved.`);
      }

      document.getElementById("screenBtn").disabled = false;
    }

    function renderResults() {
      const tbody = document.getElementById("resultsBody");
      const table = document.getElementById("resultsTable");
      const empty = document.getElementById("emptyState");
      const filters = document.getElementById("filters");

      if (allResults.length === 0) {
        table.style.display = "none";
        empty.style.display = "block";
        filters.style.display = "none";
        return;
      }

      table.style.display = "block";
      empty.style.display = "none";
      filters.style.display = "flex";

      const filtered = applyFiltersToResults();

      tbody.innerHTML = filtered.map(r => {
        return `
          <tr>
            <td><strong>${escapeHtml(r.name)}</strong></td>
            <td>${escapeHtml(r.currentCompany)}</td>
            <td>${escapeHtml(r.tenure)}</td>
            <td>${escapeHtml(r.school)}</td>
            <td>${escapeHtml(r.degree)}</td>
            <td><a href="${escapeHtml(r.url)}" target="_blank" rel="noopener noreferrer">View</a></td>
          </tr>
        `;
      }).join("");
    }

    function applyFiltersToResults() {
      const schoolFilter = (document.getElementById("filterSchool")?.value || "").toLowerCase();
      const companyFilter = (document.getElementById("filterCompany")?.value || "").toLowerCase();
      const minTenure = parseInt(document.getElementById("filterMinTenure")?.value || "0");
      const maxTenure = parseInt(document.getElementById("filterMaxTenure")?.value || "999");

      return allResults.filter(r => {
        if (schoolFilter && !r.school.toLowerCase().includes(schoolFilter)) return false;
        if (companyFilter && !r.currentCompany.toLowerCase().includes(companyFilter)) return false;
        if (r.tenureYears !== null && (r.tenureYears < minTenure || r.tenureYears > maxTenure)) return false;
        return true;
      });
    }

    function applyFilters() {
      renderResults();
    }

    function clearResults() {
      allResults = [];
      renderResults();
      document.getElementById("progress").textContent = "";
    }

    function exportCSV() {
      if (allResults.length === 0) {
        alert("No results to export");
        return;
      }

      const filtered = applyFiltersToResults();
      const csv = [
        ["Name", "Current Company", "Time", "School", "Degree", "LinkedIn URL"].join(","),
        ...filtered.map(r => [
          `"${r.name}"`,
          `"${r.currentCompany}"`,
          `"${r.tenure}"`,
          `"${r.school}"`,
          `"${r.degree}"`,
          `"${r.url}"`
        ].join(","))
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `linkedin-screen-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
    }
  </script>
</body>
</html>
